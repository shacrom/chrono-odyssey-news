---
import BaseHead from '../../components/BaseHead.astro';
import Footer from '../../components/Footer.astro';
import FormattedDate from '../../components/FormattedDate.astro';
import Header from '../../components/Header.astro';
import AdBanner from '../../components/AdBanner.astro';
import { SITE_TITLE, SITE_DESCRIPTION } from '../../consts';

// Configuración de Strapi desde variables de entorno
const STRAPI_URL = import.meta.env.STRAPI_URL || 'http://localhost:1337';

// Obtener el token JWT de la cookie (gestionado por el middleware)
const token = Astro.cookies.get('strapi_jwt')?.value;

// Función para obtener noticias usando el token de la cookie
async function fetchNoticias() {
  if (!token) {
    console.error('No se pudo obtener el token de Strapi desde la cookie');
    return [];
  }

  try {
    const response = await fetch(`${STRAPI_URL}/noticias`, {
      headers: {
        'Authorization': `Bearer ${token}`
      }
    });

    if (!response.ok) {
      throw new Error('Error obteniendo noticias');
    }

    const noticias = await response.json();
    return noticias;
  } catch (error) {
    console.error('Error obteniendo noticias:', error);
    return [];
  }
}

const noticias = await fetchNoticias();

const posts = noticias.map((noticia: any) => ({
  id: noticia.slug || noticia.id,
  data: {
    title: noticia.title,
    pubDate: new Date(noticia.publishedAt || noticia.published_at),
    heroImage: noticia.cover_image ? `${noticia.cover_image}` : null
  }
})).sort((a: any, b: any) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());
---

<!doctype html>
<html lang="en">
	<head>
		<BaseHead title={SITE_TITLE} description={SITE_DESCRIPTION} />
	</head>
	<body class="bg-graydeep relative min-h-screen overflow-x-hidden">
		<!-- Efecto de fondo animado -->
		<div class="fixed inset-0 z-0 pointer-events-none">
			<!-- Gradiente principal -->
			<div class="absolute inset-0 bg-gradient-to-br from-graydeep via-graydeep to-bronze/10"></div>
			
			<!-- Elementos decorativos dorados flotantes -->
			<div class="absolute top-20 left-10 w-2 h-2 bg-gold/30 rounded-full animate-pulse"></div>
			<div class="absolute top-40 right-20 w-1 h-1 bg-silver/40 rounded-full animate-ping"></div>
			<div class="absolute top-60 left-1/4 w-3 h-3 bg-bronze/20 rounded-full animate-pulse" style="animation-delay: 1s;"></div>
			<div class="absolute bottom-40 right-1/3 w-1.5 h-1.5 bg-gold/25 rounded-full animate-ping" style="animation-delay: 2s;"></div>
			<div class="absolute top-32 right-10 w-2.5 h-2.5 bg-silver/30 rounded-full animate-pulse" style="animation-delay: 3s;"></div>
			
			<!-- Rayos sutiles -->
			<div class="absolute top-0 left-1/4 w-px h-full bg-gradient-to-b from-transparent via-gold/10 to-transparent opacity-30"></div>
			<div class="absolute top-0 right-1/3 w-px h-full bg-gradient-to-b from-transparent via-bronze/10 to-transparent opacity-20" style="animation: fadeInOut 4s ease-in-out infinite;"></div>
			
			<!-- Círculo decorativo grande -->
			<div class="absolute -top-40 -right-40 w-80 h-80 bg-gradient-radial from-gold/5 to-transparent rounded-full blur-xl"></div>
			<div class="absolute -bottom-40 -left-40 w-96 h-96 bg-gradient-radial from-bronze/3 to-transparent rounded-full blur-2xl"></div>
		</div>
		
		<!-- Contenido principal con z-index superior -->
		<div class="relative z-10">
			<Header />
			
			<!-- Banner publicitario horizontal después del header -->
			<div class="w-full max-w-[960px] mx-auto px-4 py-6">
				<AdBanner type="horizontal" className="horizontal" />
			</div>
			
			<main class="w-full max-w-[960px] mx-auto px-4">
				<section>
				<ul class="flex flex-wrap gap-8 list-none m-0 p-0">
					{
						posts.map((post: any, index: number) => (
							<li class={index === 0 
								? "w-full mb-4 text-center" 
								: "w-[calc(50%-1rem)] lg:w-[calc(50%-1rem)] md:w-full"
							}>
								<a href={`/noticias/${post.id}/`} class="block transition-all duration-300 hover:transform hover:scale-105 rounded-xl p-4 backdrop-blur-glass hover:bg-black/10">
									{post.data.heroImage && (
										<img 
											src={post.data.heroImage} 
											alt="" 
											width="720" 
											height="360"
											class={`mb-2 rounded-xl shadow-lg transition-all duration-300 hover:shadow-2xl hover:shadow-gold/20 ${
												index === 0 ? "w-full" : ""
											}`}
										/>
									)}
									<h4 class={`m-0 text-white leading-tight transition-colors duration-300 hover:text-gold ${
										index === 0 ? "text-4xl lg:text-5xl" : "text-xl"
									}`}>
										{post.data.title}
									</h4>
									<p class="m-0 text-silver transition-colors duration-300 hover:text-gold">
										<FormattedDate date={post.data.pubDate} />
									</p>
								</a>
							</li>
						))
					}
				</ul>
			</section>
		</main>
		<Footer />
		</div>
		
		<!-- Animaciones CSS personalizadas -->
		<style>
			@keyframes fadeInOut {
				0%, 100% { opacity: 0.2; }
				50% { opacity: 0.6; }
			}
			
			@keyframes float {
				0%, 100% { transform: translateY(0px); }
				50% { transform: translateY(-10px); }
			}
			
			/* Gradiente radial personalizado */
			.bg-gradient-radial {
				background: radial-gradient(circle, var(--tw-gradient-from), var(--tw-gradient-to));
			}
			
			/* Efecto de glassmorphism sutil en las tarjetas */
			.backdrop-blur-glass {
				backdrop-filter: blur(10px);
				background: rgba(255, 255, 255, 0.05);
				border: 1px solid rgba(255, 255, 255, 0.1);
			}
		</style>
	</body>
</html>
